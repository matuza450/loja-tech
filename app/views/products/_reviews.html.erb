<div id="reviews" class="mb-4">
  <h4>Avaliações</h4>
  <p>Média: <strong><%= product.average_rating %></strong> / 5 (<%= pluralize(product.reviews.count, 'avaliação') %>)</p>

  <% if logged_in? %>
    <% existing = product.reviews.find_by(user: current_user) %>
    <%= form_with(model: [product, existing || product.reviews.new], local: true) do |f| %>
      <div class="mb-2">
        <%= f.label :rating, 'Nota (1-5)' %>
        <%= f.number_field :rating, in: 1..5, class: 'form-control', value: (existing&.rating || 5) %>
      </div>
      <div class="mb-2">
        <%= f.label :body, 'Comentário (opcional)' %>
        <%= f.text_area :body, class: 'form-control', rows: 3, value: existing&.body %>
      </div>
      <%= f.submit (existing ? 'Atualizar avaliação' : 'Avaliar'), class: 'btn btn-primary btn-sm' %>
      <% if existing %>
        <%= button_to [product, existing], method: :delete, data: { confirm: 'Remover avaliação?' }, class: 'btn btn-link btn-sm text-danger ms-2' do %>
          Remover
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <p><%= link_to 'Faça login', login_path %> para avaliar.</p>
  <% end %>

  <div class="mt-3">
    <% product.reviews.order(created_at: :desc).each do |r| %>
      <div class="card mb-2">
        <div class="card-body">
          <strong><%= r.user.name %></strong>
          <small class="text-muted"> • <%= r.rating %> / 5</small>
          <p class="mb-0 mt-2"><%= r.body %></p>
        </div>
      </div>
    <% end %>
  </div>
</div>